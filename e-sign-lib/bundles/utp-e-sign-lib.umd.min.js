!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("js2xmlparser"),require("@epsr/crypto-pro"),require("@angular/common")):"function"==typeof define&&define.amd?define("@utp/e-sign-lib",["exports","@angular/core","rxjs","rxjs/operators","js2xmlparser","@epsr/crypto-pro","@angular/common"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).utp=e.utp||{},e.utp["e-sign-lib"]={}),e.ng.core,e.rxjs,e.rxjs.operators,e.JsonToXML,e.cryptoPro,e.ng.common)}(this,(function(e,t,n,r,s,i,o){"use strict";var a,u=function(e){var t=e.cadesVersion,n=e.cspVersion;this.pluginVersion=t,this.cspVersion=n};!function(e){e[e.CertificateNotFound=0]="CertificateNotFound",e[e.PluginNotFined=1]="PluginNotFined",e[e.SignNotInGOST=2]="SignNotInGOST",e[e.SignError=3]="SignError",e[e.Success=4]="Success"}(a||(a={}));var c=Object.freeze({__proto__:null,CryptoProPluginInfo:u,get ErrorCryptoPro(){return a}});
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function l(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((r=r.apply(e,t||[])).next())}))}function p(e,t){var n,r,s,i,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){o.label=i[1];break}if(6===i[0]&&o.label<s[1]){o.label=s[1],s=i;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(i);break}s[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}Object.create;Object.create;var d=function(){function e(){}return e.map=function(e){if(!e)return null;var t=e.issuerName,n=e.name,r=e.thumbprint,s=e.validFrom,i=e.validTo,o=t.match(/CN=([^,+]*)/);return{issuerName:o&&o.length>0?o[1]:t,isValid:!0,name:n,thumbprint:r,validFrom:s,validTo:i}},e}(),f={issuerName:"Тестовый сертификат",isValid:!0,name:"Test Certificate",thumbprint:"A2C5DF002CF2260D13D38186AE8C99C9BE660602",validFrom:"2021-04-05T16:35:09.000Z",validTo:"2021-07-05T16:45:09.000Z"},g=function(){function e(){this.isPlugin=!1,"cadesplugin_skip_extension_install"in window&&(window.cadesplugin_skip_extension_install=!0)}return e.prototype.isPluginValid=function(){var e=this;return n.from(i.isValidSystemSetup()).pipe(r.tap((function(t){return e.isPlugin=t}),r.catchError((function(t){return e.isPlugin=!1,t}))))},e.prototype.getPluginInfo=function(){return n.from(i.getSystemInfo()).pipe(r.map((function(e){return new u(e)})))},e.prototype.getUserCertificates=function(){return new n.Observable((function(e){return n.from(i.getUserCertificates(!0)).subscribe(e)}))},e.prototype.createFileSignature=function(e,t){var r=this;return new n.Observable((function(s){return n.from(r.createFileDetachedSignature(e,t)).subscribe(s)}))},e.prototype.createXMLSignature=function(e,t){var r=this;return new n.Observable((function(s){return n.from(r.createXMLSignaturePromise(e,t)).subscribe(s)}))},e.prototype.createXMLSignaturePromise=function(e,t){return l(this,void 0,void 0,(function(){return p(this,(function(n){switch(n.label){case 0:return[4,i.createXMLSignature(e,t)];case 1:return[2,n.sent()]}}))}))},e.prototype.createFileDetachedSignature=function(e,t){return l(this,void 0,void 0,(function(){var n,r;return p(this,(function(s){switch(s.label){case 0:return[4,t.arrayBuffer()];case 1:return n=s.sent(),[4,i.createHash(n)];case 2:return r=s.sent(),[4,i.createDetachedSignature(e,r)];case 3:return[2,s.sent()]}}))}))},e}();g.ɵfac=function(e){return new(e||g)},g.ɵprov=t.ɵɵdefineInjectable({token:g,factory:g.ɵfac}),("undefined"==typeof ngDevMode||ngDevMode)&&t.ɵsetClassMetadata(g,[{type:t.Injectable}],(function(){return[]}),null);var m=function(){function e(e){this.cryptoService=e,this.isPluginValid=!1,this.signInProgress=!1,this.signEvent$=new n.BehaviorSubject(null),this.isTestingMode="true"===localStorage.getItem("SIGN_XML_TESTING_MODE"),this.rootField="html",this.jsonObject={},this.isNeedDownloadFile=!1,this.successResult=new t.EventEmitter(null),this.failedResult=new t.EventEmitter(null),this.getXMLTemplate=function(e,t,n,r){return'<?xml version="1.0" encoding="UTF-8"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" xmlns:u="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd">    <s:Header>        <o:Security s:mustUnderstand="1" xmlns:o="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" s:actor="http://smev.gosuslugi.ru/actors/smev">            <o:BinarySecurityToken u:Id="uuid-ee82d445-758b-42cb-996c-666b74b60022-2" ValueType="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3" EncodingType="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-soap-message-security-1.0#Base64Binary">'+t+'</o:BinarySecurityToken>            <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">                <SignedInfo>                    <CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#" />                    <SignatureMethod Algorithm="'+n+'"/>                    <Reference URI="#_1">                        <Transforms>                            <Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#" />                        </Transforms>                        <DigestMethod Algorithm="'+r+'"/>                        <DigestValue></DigestValue>                    </Reference>                </SignedInfo>                <SignatureValue></SignatureValue>                <KeyInfo>                    <o:SecurityTokenReference>                    <o:Reference ValueType="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3" URI="#uuid-ee82d445-758b-42cb-996c-666b74b60022-2" />                    </o:SecurityTokenReference>                </KeyInfo>            </Signature>        </o:Security>    </s:Header>    <s:Body u:Id="_1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">'+e+"    </s:Body></s:Envelope>"},this.listenSignEvents()}return e.prototype.keyEvent=function(e){e.altKey&&"KeyS"===e.code&&(this.isTestingMode=!this.isTestingMode,localStorage.setItem("SIGN_XML_TESTING_MODE",String(this.isTestingMode)),console.log("SIGN_XML_TESTING_MODE: ",this.isTestingMode?"on":"off"))},e.prototype.listenSignEvents=function(){var e=this;return this.signEvent$.pipe(r.filter((function(e){return e})),r.tap((function(t){var n=t.status,r=t.payload;return e.signInProgress=!1,n===a.Success?(e.successResult.emit({status:n,payload:r}),e.selectedCertificate=null,void(e.isNeedDownloadFile&&e.downloadFile(r,"signed.xml"))):(e.selectedCertificate&&(e.selectedCertificate.isValid=!1,e.selectedCertificate.class="disabled"),void e.failedResult.emit({status:n,payload:r}))}))).subscribe()},e.prototype.checkPlugin=function(){this.isPluginValid=this.cryptoService.isPlugin,this.isPluginValid||this.isTestingMode||this.signEvent$.next({status:a.PluginNotFined,payload:"Требуется  КриптоПро ЭЦП Browser plug-in и установленная ЭЦП"})},e.prototype.onCertificateSelected=function(e){this.selectedCertificate=e},e.prototype.getCertificates=function(){var e=this;if(!this.jsonObject)return n.of(null);return e.checkPlugin(),n.iif((function(){return e.isPluginValid}),e.cryptoService.getUserCertificates(),n.of(e.isTestingMode?[f]:[])).pipe(r.map((function(e){return e.map((function(e){return d.map(e)}))})),r.tap((function(t){e.certificates=t})),r.catchError((function(t){return e.certificates=[],e.signEvent$.next({status:a.PluginNotFined,payload:"Требуется  КриптоПро ЭЦП Browser plug-in и установленная ЭЦП"}),n.throwError(t)})))},e.prototype.downloadFile=function(e,t){void 0===t&&(t="filename.xml");var n=document.createElement("a"),r=new Blob([e],{type:"text/plain"});n.setAttribute("href",window.URL.createObjectURL(r)),n.setAttribute("download",t),n.dataset.downloadurl=["text/plain",n.download,n.href].join(":"),n.draggable=!0,n.classList.add("dragout"),n.click(),n.remove()},Object.defineProperty(e.prototype,"jsonToXml",{get:function(){return s.parse(this.rootField,this.jsonObject).replace("<?xml version='1.0'?>\n","")},enumerable:!1,configurable:!0}),e.prototype.sign=function(){var e=this.jsonToXml;if(this.signInProgress=!0,this.selectedCertificate&&this.selectedCertificate.thumbprint!==f.thumbprint)this.signXML(this.selectedCertificate.thumbprint,e);else{var t=this.isTestingMode?{status:a.Success,payload:this.getXMLTemplate(e,"","","")}:{status:a.PluginNotFined,payload:"Требуется  КриптоПро ЭЦП Browser plug-in и установленная ЭЦП"};this.signEvent$.next(t)}},e.prototype.signXML=function(e,t){var n;n=this,cadesplugin.async_spawn((function(r){var s,i,o,u,c,l,d,f,g,m,h,y;return p(this,(function(r){switch(r.label){case 0:return""===e?(alert("Введите имя сертификата (CN)."),[2]):[4,cadesplugin.CreateObjectAsync("CAdESCOM.Store")];case 1:return[4,(s=r.sent()).Open(2,"My",2,4)];case 2:return r.sent(),[4,s.Certificates];case 3:return[4,r.sent().Find(0,e)];case 4:return[4,(i=r.sent()).Count];case 5:return 0===r.sent()?(n.signEvent$.next({status:a.CertificateNotFound,payload:e}),[2]):[4,i.Item(1)];case 6:return o=r.sent(),[4,s.Close()];case 7:return r.sent(),[4,o.PublicKey()];case 8:return[4,r.sent().Algorithm];case 9:return[4,r.sent().Value];case 10:return u=r.sent(),c="",l="","1.2.643.7.1.1.1.1"===u?(c="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34102012-gostr34112012-256",l="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34112012-256"):"1.2.643.7.1.1.1.2"===u?(c="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34102012-gostr34112012-512",l="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34112012-512"):"1.2.643.2.2.19"===u?(c="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34102001-gostr3411",l="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr3411"):n.signEvent$.next({status:a.SignNotInGOST,payload:"Поддерживается XML подпись сертификатами только с алгоритмом ГОСТ Р 34.10-2012, ГОСТ Р 34.10-2001"}),[4,o.Export(0)];case 11:return d=(d=r.sent()).replace(/[\r\n]/g,""),f=n.getXMLTemplate(t,d,c,l),[4,cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner")];case 12:return[4,(g=r.sent()).propset_Certificate(o)];case 13:return r.sent(),[4,g.propset_CheckCertificate(!0)];case 14:return r.sent(),[4,cadesplugin.CreateObjectAsync("CAdESCOM.SignedXML")];case 15:return[4,(m=r.sent()).propset_Content(f)];case 16:return r.sent(),[4,m.propset_SignatureType(2)];case 17:r.sent(),h="",r.label=18;case 18:return r.trys.push([18,20,,21]),[4,m.Sign(g)];case 19:return h=r.sent(),n.signEvent$.next({status:a.Success,payload:h}),[3,21];case 20:return y=r.sent(),n.signEvent$.next({status:a.SignError,payload:cadesplugin.getLastError(y.message)}),[2];case 21:return[2]}}))}))},e}();m.ɵfac=function(e){return new(e||m)(t.ɵɵdirectiveInject(g))},m.ɵdir=t.ɵɵdefineDirective({type:m,selectors:[["","xml-e-sign",""]],hostBindings:function(e,n){1&e&&t.ɵɵlistener("keyup",(function(e){return n.keyEvent(e)}),!1,t.ɵɵresolveWindow)},inputs:{rootField:"rootField",jsonObject:"jsonObject",isNeedDownloadFile:"isNeedDownloadFile"},outputs:{successResult:"successResult",failedResult:"failedResult"},exportAs:["xmlESign"]}),("undefined"==typeof ngDevMode||ngDevMode)&&t.ɵsetClassMetadata(m,[{type:t.Directive,args:[{selector:"[xml-e-sign]",exportAs:"xmlESign"}]}],(function(){return[{type:g}]}),{rootField:[{type:t.Input}],jsonObject:[{type:t.Input}],isNeedDownloadFile:[{type:t.Input}],successResult:[{type:t.Output}],failedResult:[{type:t.Output}],keyEvent:[{type:t.HostListener,args:["window:keyup",["$event"]]}]});var h=function(e){this.cryptoService=e,this.cryptoService.isPluginValid().subscribe()};h.ɵfac=function(e){return new(e||h)(t.ɵɵinject(g))},h.ɵmod=t.ɵɵdefineNgModule({type:h}),h.ɵinj=t.ɵɵdefineInjector({providers:[g],imports:[[o.CommonModule]]}),("undefined"==typeof ngJitMode||ngJitMode)&&t.ɵɵsetNgModuleScope(h,{declarations:[m],imports:[o.CommonModule],exports:[m]}),("undefined"==typeof ngDevMode||ngDevMode)&&t.ɵsetClassMetadata(h,[{type:t.NgModule,args:[{imports:[o.CommonModule],providers:[g],declarations:[m],exports:[m]}]}],(function(){return[{type:g}]}),null),e.CryptoProService=g,e.ESignerModule=h,e.XMLESignDirective=m,e.models=c,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=utp-e-sign-lib.umd.min.js.map